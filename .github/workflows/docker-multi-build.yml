name: Build, Push, and Secure Multiple Docker Images to GHCR

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAMESPACE: ${{ github.repository_owner }}
  PLATFORMS: linux/amd64,linux/arm64
  # Retention days for untagged images
  IMAGE_RETENTION_DAYS: 30
  KEEP_RECENT_VERSIONS: 5 # Keep the 5 most recent tagged versions
  ARTIFACT_REPO: us-central1-docker.pkg.dev/gen-lang-client-0537147856/backend

jobs:
  test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: app/backend

    services:
      postgres_db:
        image: postgres:13.22-alpine3.22
        env:
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
        # Expose the port so the runner can see it
        ports:
          - 5432:5432
        # Health check ensures the DB is ready before tests start
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:8.2-bookworm
        ports:
          - "6379:6379"

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install uv
          uv sync --all-extras

      - name: Load environment variables
        run: |
          export ENVIRONMENT=testing
          echo "${{ secrets.TEST_ENV_BASE64 }}" | base64 -d > .env.testing
          echo "POSTGRES_SERVER=127.0.0.1" >> .env.testing
          echo "REDIS_SERVER=127.0.0.1" >> .env.testing

      - name: Run tests
        run: |
          uv run pytest --cov --cov-branch --cov-report=xml:test-reports/coverage.xml

      - name: Upload test results for artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-for-artifact
          path: test-reports/
          retention-days: 15

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:
          name: test-results-for-codecov
          files: test-reports/coverage.xml

  test-db-migrations:
    runs-on: ubuntu-latest

    permissions:
      contents: "read"
      id-token: "write"

    steps:
      - uses: actions/checkout@v4
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - id: "auth"
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      # Set up gcloud CLI
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Download Sanitized Dump
        run: |
          gsutil cp gs://${{ secrets.GCS_BUCKET_NAME }}/backup-latest.sql.gz .
          gzip --stdout --decompress backup-latest.sql.gz > backup-latest.sql

      - name: Load environment variables
        run: |
          echo "${{ secrets.TEST_ENV_BASE64 }}" | base64 -d > ./app/backend/.env.testing

      - name: Start Database Only
        run: docker compose -f docker-compose.local-test.yml up -d test_postgres_db --wait

        # HYDRATION (Import data into the service container)
      - name: "Hydrate Test Database"
        run: |
          docker compose -f docker-compose.local-test.yml run \
            --rm \
            -e PGPASSWORD=${{ secrets.TEST_POSTGRES_PASSWORD }} \
            -v $(pwd)/backup-latest.sql:/backup-latest.sql \
            test_postgres_db \
            psql -h test_postgres_db -U ${{ secrets.POSTGRES_USER }} -d ${{ secrets.POSTGRES_DB }} -f /backup-latest.sql

      - name: Build images
        run: docker compose -f docker-compose.local-test.yml build

      # Use 'run' instead of 'exec' before the full stack is up
      - name: Run migrations
        run: docker compose -f docker-compose.local-test.yml run --rm backend alembic upgrade head

      # Now start everything and wait for that healthcheck
      - name: Start Services
        run: docker compose -f docker-compose.local-test.yml up -d --wait

  build-and-push:
    runs-on: ubuntu-latest
    needs: [test, test-db-migrations]
    strategy:
      fail-fast: false # Let all matrix jobs complete
      matrix:
        image_config:
          - name: "backend"
            dockerfile: "app/backend/Dockerfile"
            context: "app/backend"

          - name: "frontend"
            dockerfile: "app/frontend/Dockerfile"
            context: "app/frontend"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: ${{ env.PLATFORMS }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ matrix.image_config.name }}
          tags: |
            type=sha,prefix=sha-,format=short
            latest
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.image_config.context }}
          file: ${{ matrix.image_config.dockerfile }}
          build-args: |
            VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }}
          platforms: ${{ env.PLATFORMS }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  test-pushed-image:
    runs-on: ubuntu-latest
    needs: build-and-push

    permissions:
      contents: "read"
      id-token: "write"

    steps:
      - uses: actions/checkout@v4
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - id: "auth"
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      # Set up gcloud CLI
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Download Sanitized Dump
        run: |
          gsutil cp gs://${{ secrets.GCS_BUCKET_NAME }}/backup-latest.sql.gz .
          gzip --stdout --decompress backup-latest.sql.gz > backup-latest.sql

      - name: Load environment variables
        run: |
          echo "${{ secrets.TEST_ENV_BASE64 }}" | base64 -d > ./app/backend/.env.testing

      - name: Start Database Only
        run: docker compose -f docker-compose.test.yml up -d test_postgres_db --wait

        # HYDRATION (Import data into the service container)
      - name: "Hydrate Test Database"
        run: |
          docker compose -f docker-compose.local-test.yml run \
            --rm \
            -e PGPASSWORD=${{ secrets.TEST_POSTGRES_PASSWORD }} \
            -v $(pwd)/backup-latest.sql:/backup-latest.sql \
            test_postgres_db \
            psql -h test_postgres_db -U ${{ secrets.POSTGRES_USER }} -d ${{ secrets.POSTGRES_DB }} -f /backup-latest.sql

      - name: Build images
        run: docker compose -f docker-compose.test.yml pull

      # Use 'run' instead of 'exec' before the full stack is up
      - name: Run migrations
        run: docker compose -f docker-compose.test.yml run --rm backend alembic upgrade head

      # Now start everything and wait for that healthcheck
      - name: Start Services
        run: docker compose -f docker-compose.test.yml up -d --wait

  deploy:
    runs-on: ubuntu-latest
    needs: test-pushed-image
    strategy:
      matrix:
        service: [backend, frontend]

    permissions:
      contents: "read"
      id-token: "write"

    steps:
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Authenticate with Google Cloud
      - id: "auth"
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      # Set up gcloud CLI
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # Authorize Docker to push to Artifact Registry
      - name: Configure Docker for GCP
        run: |
          gcloud auth configure-docker us-central1-docker.pkg.dev

      - name: Push to Artifact Registry
        run: |
          docker pull ghcr.io/rekebuba/${{ matrix.service }}:latest
          docker tag ghcr.io/rekebuba/${{ matrix.service }}:latest ${{ env.ARTIFACT_REPO }}/${{ matrix.service }}:latest
          docker push ${{ env.ARTIFACT_REPO }}/${{ matrix.service }}:latest

      - name: Run Cloud Run Job for DB Migration
        if: matrix.service == 'backend'
        run: |
          gcloud run jobs deploy migrate-db \
          --image ${{ env.ARTIFACT_REPO }}/${{ matrix.service }}:latest \
          --region us-central1 \
          --command alembic \
          --args upgrade,head \
          --set-cloudsql-instances=${{ secrets.CLOUD_SQL_CONNECTION_NAME }} \
          --service-account=${{ secrets.CLOUD_JOB_SA }}

          gcloud run jobs execute migrate-db \
            --region us-central1 \
            --wait

      - name: Deploy Backend to Cloud Run
        if: matrix.service == 'backend'
        run: |
          gcloud run deploy backend \
            --image ${{ env.ARTIFACT_REPO }}/${{ matrix.service }}:latest \
            --region us-central1 \
            --platform managed \
            --allow-unauthenticated \
            --add-cloudsql-instances=${{ secrets.CLOUD_SQL_CONNECTION_NAME }}

      - name: Deploy Frontend to Cloud Run
        if: matrix.service == 'frontend'
        run: |
          gcloud run deploy frontend \
            --image ${{ env.ARTIFACT_REPO }}/${{ matrix.service }}:latest \
            --region us-central1 \
            --platform managed \
            --allow-unauthenticated
